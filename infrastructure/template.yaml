AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Campus Cloud File Sharing & Submission System - Serverless Infrastructure

# Global configuration for all serverless functions
Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 512
    Environment:
      Variables:
        FILES_TABLE: !Ref FilesTable
        SHARES_TABLE: !Ref SharesTable
        ASSIGNMENTS_TABLE: !Ref AssignmentsTable
        SUBMISSIONS_TABLE: !Ref SubmissionsTable
        USERS_TABLE: !Ref UsersTable
        S3_BUCKET: !Ref FilesBucket
        ENABLE_NOTIFICATIONS: 'false'
    Tracing: Active
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization,X-Requested-With'"
      AllowOrigin: "'*'"
    Auth:
      DefaultAuthorizer: CognitoAuthorizer
      Authorizers:
        CognitoAuthorizer:
          UserPoolArn: !GetAtt UserPool.Arn

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Deployment environment

  DomainName:
    Type: String
    Default: campuscloud.edu
    Description: Domain name for the application

  AdminEmail:
    Type: String
    Description: Email address for admin notifications

Resources:
  # ============================================
  # COGNITO USER POOL
  # ============================================
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${AWS::StackName}-users'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      UsernameConfiguration:
        CaseSensitive: false
      Schema:
        - Name: email
          Required: true
          Mutable: false
        - Name: name
          Required: true
          Mutable: true
        - Name: university_id
          AttributeDataType: String
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${AWS::StackName}-client'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes

  StudentGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: student
      UserPoolId: !Ref UserPool
      Description: Students can upload files and submit assignments

  InstructorGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: instructor
      UserPoolId: !Ref UserPool
      Description: Instructors can create assignments and grade submissions

  AdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: admin
      UserPoolId: !Ref UserPool
      Description: Administrators have full access

  # ============================================
  # S3 BUCKET FOR FILE STORAGE
  # ============================================
  FilesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-files-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 90
          - Id: MoveToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
          - Id: MoveToGlacier
            Status: Enabled
            Transitions:
              - TransitionInDays: 365
                StorageClass: GLACIER
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - '*'
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedHeaders:
              - '*'
            MaxAge: 3000

  FilesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FilesBucket
      PolicyDocument:
        Statement:
          - Sid: AllowLambdaAccess
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
            Resource: !Sub '${FilesBucket.Arn}/*'

  # ============================================
  # S3 BUCKET FOR FRONTEND HOSTING
  # ============================================
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-frontend-${AWS::AccountId}'
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: s3:GetObject
            Resource: !Sub '${FrontendBucket.Arn}/*'

  # ============================================
  # CLOUDFRONT DISTRIBUTION
  # ============================================
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt FrontendBucket.DomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          Compress: true
          MinTTL: 0
          DefaultTTL: 3600
          MaxTTL: 86400
        PriceClass: PriceClass_100
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  # ============================================
  # DYNAMODB TABLES
  # ============================================
  FilesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-files'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: fileId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: uploadedAt
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: fileId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: FileIdIndex
          KeySchema:
            - AttributeName: fileId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: uploadedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment

  SharesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-shares'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      AttributeDefinitions:
        - AttributeName: fileId
          AttributeType: S
        - AttributeName: sharedWithUserId
          AttributeType: S
        - AttributeName: shareId
          AttributeType: S
        - AttributeName: sharedAt
          AttributeType: S
      KeySchema:
        - AttributeName: fileId
          KeyType: HASH
        - AttributeName: sharedWithUserId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: SharedWithUserIndex
          KeySchema:
            - AttributeName: sharedWithUserId
              KeyType: HASH
            - AttributeName: sharedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ShareIdIndex
          KeySchema:
            - AttributeName: shareId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment

  AssignmentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-assignments'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: courseId
          AttributeType: S
        - AttributeName: assignmentId
          AttributeType: S
        - AttributeName: instructorId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: dueDate
          AttributeType: S
      KeySchema:
        - AttributeName: courseId
          KeyType: HASH
        - AttributeName: assignmentId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: InstructorIndex
          KeySchema:
            - AttributeName: instructorId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StatusDueDateIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: dueDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: AssignmentIdIndex
          KeySchema:
            - AttributeName: assignmentId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment

  SubmissionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-submissions'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: assignmentId
          AttributeType: S
        - AttributeName: studentId#submissionNumber
          AttributeType: S
        - AttributeName: studentId
          AttributeType: S
        - AttributeName: submittedAt
          AttributeType: S
        - AttributeName: submissionId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: assignmentId
          KeyType: HASH
        - AttributeName: studentId#submissionNumber
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: StudentIndex
          KeySchema:
            - AttributeName: studentId
              KeyType: HASH
            - AttributeName: submittedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: SubmissionIdIndex
          KeySchema:
            - AttributeName: submissionId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: submittedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-users'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # ============================================
  # API GATEWAY
  # ============================================
  CampusCloudApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub '${AWS::StackName}-api'
      StageName: !Ref Environment
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt ApiLogGroup.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","routeKey":"$context.routeKey","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}'

  ApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${AWS::StackName}-api'
      RetentionInDays: 30

  # ============================================
  # LAMBDA FUNCTIONS
  # ============================================
  GeneratePresignedUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-generate-presigned-url'
      CodeUri: ../backend/lambdas/
      Handler: generate_presigned_url.lambda_handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FilesTable
        - DynamoDBReadPolicy:
            TableName: !Ref SharesTable
        - S3CrudPolicy:
            BucketName: !Ref FilesBucket
      Events:
        UploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files/upload-url
            Method: POST
        DownloadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files/{fileId}/download-url
            Method: POST

  CompleteUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-complete-upload'
      CodeUri: ../backend/lambdas/
      Handler: complete_upload.lambda_handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FilesTable
        - S3ReadPolicy:
            BucketName: !Ref FilesBucket
      Events:
        CompleteUpload:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files/{fileId}/complete
            Method: POST

  ListFilesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-list-files'
      CodeUri: ../backend/lambdas/
      Handler: list_files.lambda_handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref FilesTable
        - DynamoDBReadPolicy:
            TableName: !Ref SharesTable
      Events:
        ListFiles:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files
            Method: GET

  ShareFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-share-file'
      CodeUri: ../backend/lambdas/
      Handler: share_file.lambda_handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FilesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref SharesTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        ShareFile:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files/{fileId}/share
            Method: POST
        ListShares:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files/{fileId}/shares
            Method: GET
        RevokeShare:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /files/{fileId}/shares/{shareId}
            Method: DELETE
        SharedWithMe:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /shared-with-me
            Method: GET

  SubmitAssignmentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-submit-assignment'
      CodeUri: ../backend/lambdas/
      Handler: submit_assignment.lambda_handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FilesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AssignmentsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref SubmissionsTable
      Events:
        SubmitAssignment:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /assignments/{assignmentId}/submit
            Method: POST
        ListSubmissions:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /assignments/{assignmentId}/submissions
            Method: GET
        MySubmissions:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /assignments/{assignmentId}/submissions/me
            Method: GET
        GradeSubmission:
          Type: Api
          Properties:
            RestApiId: !Ref CampusCloudApi
            Path: /assignments/{assignmentId}/submissions/{submissionId}/grade
            Method: PUT

  # ============================================
  # CLOUDWATCH ALARMS
  # ============================================
  ApiErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-api-errors'
      AlarmDescription: Alert when API error rate is high
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${AWS::StackName}-api'

  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-lambda-errors'
      AlarmDescription: Alert when Lambda error rate is high
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold

  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-dynamodb-throttle'
      AlarmDescription: Alert when DynamoDB requests are throttled
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold

# ============================================
# OUTPUTS
# ============================================
Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolId'

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolClientId'

  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${CampusCloudApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  FilesBucketName:
    Description: S3 bucket for file storage
    Value: !Ref FilesBucket
    Export:
      Name: !Sub '${AWS::StackName}-FilesBucket'

  FrontendBucketName:
    Description: S3 bucket for frontend hosting
    Value: !Ref FrontendBucket
    Export:
      Name: !Sub '${AWS::StackName}-FrontendBucket'

  CloudFrontURL:
    Description: CloudFront distribution URL
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontURL'

  FilesTableName:
    Description: DynamoDB Files table name
    Value: !Ref FilesTable

  SharesTableName:
    Description: DynamoDB Shares table name
    Value: !Ref SharesTable

  AssignmentsTableName:
    Description: DynamoDB Assignments table name
    Value: !Ref AssignmentsTable

  SubmissionsTableName:
    Description: DynamoDB Submissions table name
    Value: !Ref SubmissionsTable

  UsersTableName:
    Description: DynamoDB Users table name
    Value: !Ref UsersTable
